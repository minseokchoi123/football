<script>
  import Icon from "@iconify/svelte";
  // Svelte 5 + daisyUI 간단한 족구 팀 배정
  function getRandomSkill() {
    return Math.floor(Math.random() * 101);
  }
  // 롤 티어 변환 함수 (수식어 제거, 아이언~다이아까지 medal 아이콘, 이후 기존 아이콘)
  function getLolTier(skill) {
    if (skill <= 9) return { name: "아이언", icon: "mdi:medal", color: "text-gray-500" };
    if (skill <= 19) return { name: "브론즈", icon: "mdi:medal", color: "text-yellow-700" };
    if (skill <= 29) return { name: "실버", icon: "mdi:medal", color: "text-gray-400" };
    if (skill <= 39) return { name: "골드", icon: "mdi:medal", color: "text-yellow-400" };
    if (skill <= 49) return { name: "플래티넘", icon: "mdi:medal", color: "text-cyan-400" };
    if (skill <= 69) return { name: "다이아", icon: "mdi:medal", color: "text-blue-400" };
    if (skill <= 79) return { name: "마스터", icon: "mdi:crown-outline", color: "text-purple-500" };
    if (skill <= 89) return { name: "마스터", icon: "mdi:crown", color: "text-red-500" };
    return { name: "챌린저", icon: "mdi:star-check-outline", color: "text-yellow-500" };
  }
  let people = $state([
    { name: '철수', skill: getRandomSkill() },
    { name: '영희', skill: getRandomSkill() },
    { name: '민수', skill: getRandomSkill() },
    { name: '지영', skill: getRandomSkill() },
    { name: '준호', skill: getRandomSkill() },
    { name: '수진', skill: getRandomSkill() },
    { name: '현우', skill: getRandomSkill() },
    { name: '나영', skill: getRandomSkill() }
  ]);
  let newPerson = $state('');
  let editingSkillIdx = $state(null);
  let tempSkill = $state(50);
  let teamAssignments = $state({
    A: [null, null, null, null],
    B: [null, null, null, null]
  });
  // 커스텀 드롭다운 열림 상태
  let openA = $state([false, false, false, false]);
  let openB = $state([false, false, false, false]);

  // Derived values
  const teamACount = $derived(teamAssignments.A.filter(p => p !== null).length);
  const teamBCount = $derived(teamAssignments.B.filter(p => p !== null).length);
  const maxAssigned = 8;
  const allAssigned = $derived([...teamAssignments.A, ...teamAssignments.B].filter(p => p !== null));
  const uniqueAssignedCount = $derived(Array.from(new Set(allAssigned.map(p => p?.name))).length);
  const unassignedCount = $derived(maxAssigned - uniqueAssignedCount);
  const canAddPerson = $derived(
    newPerson.trim() &&
    !people.some(p => p.name === newPerson.trim()) &&
    people.length < 20
  );

  // 팀별 점수 총합
  const teamASum = $derived(teamAssignments.A.reduce((sum, p) => sum + (p?.skill ?? 0), 0));
  const teamBSum = $derived(teamAssignments.B.reduce((sum, p) => sum + (p?.skill ?? 0), 0));

  function addPerson() {
    if (canAddPerson) {
     people.push({ name: newPerson.trim(), skill: getRandomSkill() });
     newPerson = '';
    }
  }

  function removePerson(personToRemove) {
    teamAssignments.A = teamAssignments.A.map(p => p?.name === personToRemove.name ? null : p);
    teamAssignments.B = teamAssignments.B.map(p => p?.name === personToRemove.name ? null : p);
    people = people.filter(p => p.name !== personToRemove.name);
  }

  function availableOptions(team, idx) {
    return people.filter(
      p => !allAssigned.some(ap => ap.name === p.name) || (teamAssignments[team][idx]?.name === p.name)
    );
  }

  function selectA(idx, person) {
    teamAssignments.A[idx] = person;
    openA[idx] = false;
  }
  function selectB(idx, person) {
    teamAssignments.B[idx] = person;
    openB[idx] = false;
  }

  function clearAll() {
    teamAssignments.A = [null, null, null, null];
    teamAssignments.B = [null, null, null, null];
  }

  function handleKeydown(event) {
    if (event.key === 'Enter') {
      addPerson();
    }
  }

  // 셔플 함수: 각 라인별로만 섞기 (A팀 1번과 B팀 1번끼리, 2번끼리 ...)
  function shuffleTeams() {
    // 각 라인별로 현재 배정된 인원 추출
    for (let i = 0; i < 4; i++) {
      const pair = [teamAssignments.A[i], teamAssignments.B[i]].filter(p => p !== null);
      // 셔플 (Fisher-Yates)
      for (let j = pair.length - 1; j > 0; j--) {
        const k = Math.floor(Math.random() * (j + 1));
        [pair[j], pair[k]] = [pair[k], pair[j]];
      }
      // 다시 배정
      teamAssignments.A[i] = pair[0] || null;
      teamAssignments.B[i] = pair[1] || null;
    }
  }
</script>

<div class="min-h-screen bg-base-200 flex items-center justify-center">
  <div class="max-w-6xl w-full mx-auto flex flex-col items-center justify-center">
    <!-- Header -->
    <div class="text-center mb-6 w-full">
      <h1 class="text-4xl font-bold text-base-content mb-2">⚽ 족구 팀 배정</h1>
      <div class="stats stats-horizontal shadow bg-base-100 flex justify-center">
        <div class="stat place-items-center">
          <div class="stat-title">총 인원</div>
          <div class="stat-value text-lg">{people.length}</div>
        </div>
        <div class="stat place-items-center">
          <div class="stat-title">A팀</div>
          <div class="stat-value text-lg text-primary">{teamACount}/4</div>
        </div>
        <div class="stat place-items-center">
          <div class="stat-title">B팀</div>
          <div class="stat-value text-lg text-secondary">{teamBCount}/4</div>
        </div>
        <div class="stat place-items-center">
          <div class="stat-title">미배정</div>
          <div class="stat-value text-lg text-warning">{unassignedCount}</div>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 w-full justify-center items-stretch">
      <!-- 인원 관리 -->
      <div class="card bg-base-100 shadow flex-1 flex flex-col h-full" id="main-card">
        <div class="card-body p-4 flex flex-col h-full">
          <h2 class="card-title text-lg">👥 인원 관리</h2>

          <!-- 추가 -->
          <div class="flex gap-2 mb-4">
            <input
              class="input input-bordered input-sm flex-1"
              type="text"
              placeholder="이름 입력"
              bind:value={newPerson}
              onkeydown={handleKeydown}
            />
            <button
              class="btn btn-sm btn-success"
              onclick={addPerson}
              disabled={!canAddPerson}
            >
              추가
            </button>
          </div>

          <!-- 목록 -->
          <div class="max-h-40 overflow-y-auto flex-1 mb-2">
            {#if people.length === 0}
              <p class="text-base-content/60 text-center py-4">인원이 없습니다</p>
            {:else}
              <div class="space-y-1">
                {#each people as person, idx}
                  {@const tier = getLolTier(person.skill)}
                   <div class="flex items-center justify-between bg-base-200 p-2 rounded gap-2">
                     <div class="flex items-center gap-2">
                       <Icon icon={tier.icon} class={`text-xl ${tier.color}`} />
                       <span class="text-sm">{person.name}</span>
                       {#if editingSkillIdx === idx}
                         <input
                           type="number"
                           min="0"
                           max="100"
                           class="input input-xs w-16"
                           bind:value={tempSkill}
                         />
                         <button class="btn btn-xs btn-success btn-outline"
                           onclick={() => {
                             person.skill = Number(tempSkill);
                             editingSkillIdx = null;
                           }}>
                           저장
                         </button>
                       {:else}
                         <span class="text-xs font-bold text-primary">{person.skill}</span>
                         <button class="btn btn-xs btn-info btn-outline"
                           onclick={() => {
                             editingSkillIdx = idx;
                             tempSkill = person.skill;
                           }}>
                           수정
                         </button>
                       {/if}
                     </div>
                     <button
                       class="btn btn-xs btn-error btn-outline"
                       onclick={() => removePerson(person)}
                       >
                       ✕
                     </button>
                   </div>
                {/each}
              </div>
            {/if}
          </div>

          <!-- 액션 버튼 -->
          <div class="grid grid-cols-2 gap-2 mt-auto">
            <button
              class="btn btn-sm btn-outline"
              onclick={clearAll}
            >
              초기화
            </button>
            <button
              class="btn btn-sm btn-warning"
              onclick={shuffleTeams}
              disabled={!(teamACount === 4 && teamBCount === 4)}
            >
              팀원섞기
            </button>
          </div>
        </div>
      </div>

      <!-- A팀 -->
     <div class="card bg-base-100 shadow flex-1 flex flex-col border-l-4 border-primary" id="team-card-a">
       <div class="card-body p-4 flex flex-col">
         <h2 class="card-title text-lg text-primary">
           🔵 A팀 ({teamACount}/4)
           <span class="ml-2 text-xs text-primary">총점: {teamASum}점</span>
         </h2>

         <div class="space-y-3 flex-1">
           {#each Array(4) as _, idx}
             <div class="relative">
               <label class="text-xs text-base-content/70">{idx + 1}번</label>
               <button
                 class="w-full flex items-center gap-2 select select-bordered select-sm {teamAssignments.A[idx] ? 'select-primary' : ''}"
                 type="button"
                 onclick={() => openA[idx] = !openA[idx]}
               >
                 {#if teamAssignments.A[idx]}
                   {@const tier = getLolTier(teamAssignments.A[idx].skill)}
                    <Icon icon={tier.icon} class={`text-lg ${tier.color}`} />
                    <span>{teamAssignments.A[idx].name}</span>
                    <span class="text-xs font-bold text-primary">{teamAssignments.A[idx].skill}</span>
                  {:else}
                    <span class="text-base-content/60">선택하세요</span>
                  {/if}
               </button>
               {#if openA[idx]}
                 <div class="absolute z-10 w-full bg-base-100 border rounded shadow mt-1">
                   {#each availableOptions('A', idx) as option}
                     {@const tier = getLolTier(option.skill)}
                     <div
                       class="flex items-center gap-2 px-2 py-1 cursor-pointer hover:bg-base-200"
                       onclick={() => selectA(idx, option)}
                     >
                       <Icon icon={tier.icon} class={`text-lg ${tier.color}`} />
                       <span>{option.name}</span>
                       <span class="text-xs font-bold text-primary">{option.skill}</span>
                     </div>
                   {/each}
                 </div>
               {/if}
             </div>
           {/each}
         </div>
       </div>
     </div>

     <!-- B팀 -->
     <div class="card bg-base-100 shadow flex-1 flex flex-col border-l-4 border-secondary" id="team-card-b">
       <div class="card-body p-4 flex flex-col h-full">
         <h2 class="card-title text-lg text-secondary">
           🟣 B팀 ({teamBCount}/4)
           <span class="ml-2 text-xs text-secondary">총점: {teamBSum}점</span>
         </h2>

         <div class="space-y-3 flex-1">
           {#each Array(4) as _, idx}
             <div class="relative">
               <label class="text-xs text-base-content/70">{idx + 1}번</label>
               <button
                 class="w-full flex items-center gap-2 select select-bordered select-sm {teamAssignments.B[idx] ? 'select-secondary' : ''}"
                 type="button"
                 onclick={() => openB[idx] = !openB[idx]}
               >
                 {#if teamAssignments.B[idx]}
                   {@const tier = getLolTier(teamAssignments.B[idx].skill)}
                    <Icon icon={tier.icon} class={`text-lg ${tier.color}`} />
                    <span>{teamAssignments.B[idx].name}</span>
                    <span class="text-xs font-bold text-secondary">{teamAssignments.B[idx].skill}</span>
                  {:else}
                    <span class="text-base-content/60">선택하세요</span>
                  {/if}
               </button>
               {#if openB[idx]}
                 <div class="absolute z-10 w-full bg-base-100 border rounded shadow mt-1">
                   {#each availableOptions('B', idx) as option}
                     {@const tier = getLolTier(option.skill)}
                     <div
                       class="flex items-center gap-2 px-2 py-1 cursor-pointer hover:bg-base-200"
                       onclick={() => selectB(idx, option)}
                     >
                       <Icon icon={tier.icon} class={`text-lg ${tier.color}`} />
                       <span>{option.name}</span>
                       <span class="text-xs font-bold text-secondary">{option.skill}</span>
                     </div>
                   {/each}
                 </div>
               {/if}
             </div>
           {/each}
         </div>
       </div>
     </div>
    </div>

  </div>
</div>
